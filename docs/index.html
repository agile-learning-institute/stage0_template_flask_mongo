<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask MongoDB API Template - API Documentation</title>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5.10.5/swagger-ui.css" />
    <style>
        html {
            box-sizing: border-box;
            overflow: -moz-scrollbars-vertical;
            overflow-y: scroll;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }
        body {
            margin: 0;
            padding: 0;
            background: #fafafa;
        }
        .swagger-ui .topbar {
            background-color: #1b1b1b;
        }
        .swagger-ui .topbar .download-url-wrapper {
            display: none;
        }
    </style>
</head>
<body>
    <div id="swagger-ui"></div>
    <script src="https://unpkg.com/swagger-ui-dist@5.10.5/swagger-ui-bundle.js"></script>
    <script src="https://unpkg.com/swagger-ui-dist@5.10.5/swagger-ui-standalone-preset.js"></script>
    <script>
        window.onload = function() {
            const ui = SwaggerUIBundle({
                url: "./openapi.yaml",
                dom_id: "#swagger-ui",
                deepLinking: true,
                presets: [
                    SwaggerUIBundle.presets.apis,
                    SwaggerUIStandalonePreset
                ],
                plugins: [
                    SwaggerUIBundle.plugins.DownloadUrl
                ],
                layout: "StandaloneLayout",
                tryItOutEnabled: true,
                supportedSubmitMethods: ["get", "post", "put", "patch", "delete"],
                validatorUrl: null,
                defaultModelsExpandDepth: 1,
                defaultModelExpandDepth: 1
            });

            // Helper function to get auth token from dev-login
            window.getDevToken = async function(subject = "dev-user-1", roles = ["admin", "developer"]) {
                try {
                    const response = await fetch("http://localhost:8184/dev-login", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ subject, roles })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.access_token;
                    } else {
                        console.error("Failed to get token:", response.status, response.statusText);
                        return null;
                    }
                } catch (error) {
                    console.error("Error getting token:", error);
                    return null;
                }
            };

            // Add custom button to get dev token
            ui.onComplete(() => {
                const authActions = ui.getSystem().authActions;
                const authSelectors = ui.getSystem().authSelectors;
                
                // Create a helper button in the UI
                const authorizeBtn = document.querySelector(".btn.authorize");
                if (authorizeBtn) {
                    const getTokenBtn = document.createElement("button");
                    getTokenBtn.className = "btn";
                    getTokenBtn.textContent = "Get Dev Token";
                    getTokenBtn.style.marginLeft = "10px";
                    getTokenBtn.onclick = async function() {
                        const token = await window.getDevToken();
                        if (token) {
                            authActions.authorize({
                                bearerAuth: {
                                    name: "bearerAuth",
                                    schema: {
                                        type: "http",
                                        scheme: "bearer",
                                        bearerFormat: "JWT"
                                    },
                                    value: token
                                }
                            });
                            alert("Token retrieved and set! You can now use the 'Authorize' button to see it.");
                        } else {
                            alert("Failed to get token. Make sure the server is running and ENABLE_LOGIN=true is set.");
                        }
                    };
                    authorizeBtn.parentNode.insertBefore(getTokenBtn, authorizeBtn.nextSibling);
                }
            });
        };
    </script>
</body>
</html>

